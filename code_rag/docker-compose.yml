version: '3.8'

services:
  # 1. Qdrant Vector Database Service
  qdrant-db:
    image: qdrant/qdrant:latest
    container_name: qdrant_server
    ports:
      - "6333:6333" # gRPC 포트
      - "6334:6334" # REST 포트
    volumes:
      # 데이터를 영구적으로 저장할 볼륨 설정
      - qdrant_data:/qdrant/storage
    restart: always

  # 2. FastAPI Application Service (RAG API)
  rag-api:
    build:
      context: . # 현재 디렉토리의 Dockerfile 사용
      dockerfile: Dockerfile
    container_name: rag_api_service
    ports:
      - "8000:8000"
    # Qdrant 서비스가 먼저 시작되도록 설정
    depends_on:
      - qdrant-db
    environment:
      # FastAPI 앱이 Qdrant 서비스 이름으로 접근하도록 설정
      QDRANT_URL: "http://qdrant-db:6333"
      PORT: 8000
    # 데이터 파일 복사를 위해 volumes 대신 build context를 사용 (Dockerfile 참조)
    restart: on-failure

volumes:
  qdrant_data: