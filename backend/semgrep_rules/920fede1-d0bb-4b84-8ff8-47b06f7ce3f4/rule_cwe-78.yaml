rules:
- id: java-xxe-vulnerable-document-builder
  message: 'CWE-611: XML External Entity (XXE) vulnerability in DocumentBuilderFactory
    configuration. Missing XXE protections like feature disabling and EntityResolver.'
  severity: ERROR
  languages:
  - java
  metadata:
    cwe: CWE-611
    owasp: A10:2021 - Server-Side Request Forgery (SSRF)
    references:
    - https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html
    - https://cwe.mitre.org/data/definitions/611.html
  fix: "DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\nfactory.setFeature(\"http://apache.org/xml/features/disallow-doctype-decl\", true);\nfactory.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\nfactory.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\nfactory.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\nfactory.setXIncludeAware(false);\nfactory.setExpandEntityReferences(false);\nfactory.setEntityResolver(new EntityResolver() {\n    @Override\n    public InputSource resolveEntity(String publicId, String systemId) {\n        return new InputSource(new StringReader(\"\"));\n    }\n});\nDocumentBuilder builder = factory.newDocumentBuilder();\nbuilder.parse(new InputSource(new StringReader($XML_DATA)))"
  pattern-inside: "public * parseXML(String xmlData) throws Exception {\n  ...\n}"
  pattern: 'DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();

      DocumentBuilder builder = factory.newDocumentBuilder();

      ...

      builder.parse(new InputSource(new StringReader($XML_DATA)))'